<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Viewer - WebSocket Stream</title>
    <style>
        body { font-family: sans-serif; margin: 20px; text-align: center; }
        #screenshot-img { border: 1px solid #ccc; max-width: 90%; height: auto; margin-top: 20px; }
        .status-message { font-size: 18px; color: #333; margin-top: 10px;}
    </style>
</head>
<body>
    <h1>Screen Viewer - Live Stream</h1>
    <div class="status-message" id="status-message">Connecting to WebSocket...</div>
    <div>
        <img id="screenshot-img" src="" alt="Live screen capture stream will appear here">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const screenshotImg = document.getElementById('screenshot-img');
            const statusMessage = document.getElementById('status-message');

            // Determine WebSocket protocol based on page protocol
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsHost = window.location.host; // Assumes FastAPI server is on the same host/port
            const wsUrl = `${wsProtocol}//${wsHost}/ws`;

            console.log(`Attempting to connect to WebSocket: ${wsUrl}`);
            statusMessage.textContent = `Connecting to WebSocket: ${wsUrl}`;

            const socket = new WebSocket(wsUrl);

            socket.onopen = function(event) {
                console.log("WebSocket connection established.");
                statusMessage.textContent = "WebSocket connection established. Waiting for stream...";
            };

            socket.onmessage = function(event) {
                // Assuming the server sends base64 encoded image data, prefixed with data URI scheme
                const imageDataBase64 = event.data;
                screenshotImg.src = imageDataBase64;
                // No need for onload/onerror on the image tag itself when using data URIs like this,
                // as the data is already fully received.
                // If it was just a URL, onload/onerror would be more critical.
                if (statusMessage.textContent !== "Streaming live...") {
                    statusMessage.textContent = "Streaming live...";
                }
            };

            socket.onerror = function(error) {
                console.error("WebSocket Error: ", error);
                statusMessage.textContent = "WebSocket Error. Check console for details. Is the server running?";
                screenshotImg.alt = "WebSocket error. Cannot display stream.";
            };

            socket.onclose = function(event) {
                console.log("WebSocket connection closed.", event);
                if (event.wasClean) {
                    statusMessage.textContent = `WebSocket connection closed cleanly, code=${event.code}, reason=${event.reason}`;
                } else {
                    statusMessage.textContent = "WebSocket connection died. Refresh to try again.";
                }
                screenshotImg.alt = "WebSocket connection closed.";
            };

            // Optional: Handle window close to close WebSocket gracefully
            window.addEventListener('beforeunload', function() {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.close();
                }
            });
        });
    </script>
</body>
</html>
